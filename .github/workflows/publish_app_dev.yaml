name: app-build-android

on:
  workflow_dispatch:
  push:
    tags:
      - "dev_v*"

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master  # ä½ çš„ä»“åº“é»˜è®¤ master åˆ†æ”¯

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.0"  # å›ºå®šç¨³å®šç‰ˆï¼Œé¿å… .x å–é¢„è§ˆç‰ˆ
          channel: "stable"
          cache: true

      - name: Flutter Doctor (ç¯å¢ƒè¯Šæ–­)
        run: flutter doctor -v

      - name: Accept Android Licenses (å…³é”®ä¿®å¤ CI å¤±è´¥)
        run: yes "y" | flutter doctor --android-licenses || true  # è‡ªåŠ¨åŒæ„æ‰€æœ‰ï¼Œ|| true é˜²å·²åŒæ„æ—¶æŠ¥é”™

      - name: Flutter Clean
        run: |
          cd simple_live_app
          flutter clean

      - name: Restore packages (è¯¦ç»†æ—¥å¿—)
        run: |
          cd simple_live_app
          flutter pub get --verbose

      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor

      - name: Check Gradle Version (è°ƒè¯•ç”¨)
        run: |
          cd simple_live_app/android
          ./gradlew --version || echo "Gradle check failed"

      - name: Build APK (å…ˆç”¨ split-per-abiï¼Œæ›´ç¨³å®š)
        run: |
          cd simple_live_app
          flutter build apk --release --split-per-abi --verbose || echo "Build failed - æŸ¥çœ‹ä¸Šé¢æ—¥å¿—çš„ Gradle/Flutter é”™è¯¯"

      # å¦‚æœä½ åšæŒåª arm64ï¼Œæ³¨é‡Šä¸Šé¢ï¼Œå¯ç”¨ä¸‹é¢ï¼ˆä½† split æ›´å¯é ï¼‰
      # - name: Build APK (only arm64)
      #   run: |
      #     cd simple_live_app
      #     flutter build apk --release --target-platform android-arm64 --verbose

      - name: List Built Files (å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºè¾“å‡º)
        if: always()
        run: ls -la simple_live_app/build/app/outputs/flutter-apk/ || echo "No build output folder"

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        if: success()  # åªæˆåŠŸæ—¶ä¸Šä¼ ï¼Œé¿å…ç©ºæ–‡ä»¶
        with:
          name: android-apk
          path: |
            simple_live_app/build/app/outputs/flutter-apk/*.apk  # ç”¨é€šé…ï¼Œå…¼å®¹ split æˆ– single

      - run: echo "ğŸ Build status: ${{ job.status }}"
